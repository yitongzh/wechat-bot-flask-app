# 企业微信IP白名单配置指南

## 问题说明

如果遇到错误：`{'errcode': 60020, 'errmsg': 'not allow to access from your ip'}`

这是因为您的服务器IP不在企业微信应用的白名单中。

## 解决步骤

### 1. 获取服务器IP

#### 方法1：使用命令行
```bash
# Linux/Mac
curl ifconfig.me

# 或者
curl ipinfo.io/ip

# 或者
curl ip.sb
```

#### 方法2：使用在线工具
- 访问 https://whatismyipaddress.com/
- 查看您的公网IP地址

### 2. 配置企业微信IP白名单

1. **登录企业微信管理后台**
   - 访问：https://work.weixin.qq.com/wework_admin/

2. **进入应用管理**
   - 点击左侧菜单：应用管理 -> 自建应用

3. **选择您的应用**
   - 找到您创建的自建应用
   - 点击应用名称进入详情

4. **配置IP白名单**
   - 点击"设置API接收"
   - 找到"IP白名单"设置
   - 添加您的服务器IP地址
   - 可以添加多个IP，每行一个

### 3. 常见IP地址

#### 开发环境
- 本地开发：`127.0.0.1`
- 局域网：`192.168.x.x` 或 `10.x.x.x`

#### 云服务器
- 阿里云、腾讯云等：使用公网IP
- 内网服务器：使用内网IP

### 4. 测试连接

配置完成后，重新运行程序：

```bash
python src/wx_stockbot/main.py
```

### 5. 注意事项

1. **IP地址格式**
   - 支持单个IP：`192.168.1.1`
   - 支持IP段：`192.168.1.0/24`
   - 支持多个IP，每行一个

2. **生效时间**
   - IP白名单配置通常立即生效
   - 如果仍有问题，等待1-2分钟再试

3. **动态IP处理**
   - 如果使用动态IP，需要定期更新白名单
   - 建议使用固定IP的服务器

4. **内网穿透**
   - 如果在内网开发，可以使用内网穿透工具
   - 如：ngrok、frp等

## 故障排除

### 检查IP是否正确
```bash
# 检查当前IP
curl ifconfig.me

# 检查是否在白名单中
# 在企业微信管理后台查看已配置的IP列表
```

### 检查网络连接
```bash
# 测试到企业微信API的连接
curl -I https://qyapi.weixin.qq.com/cgi-bin/gettoken
```

### 检查应用权限
- 确保应用有发送消息的权限
- 确保应用已启用

## 联系支持

如果问题仍然存在：
1. 检查企业微信官方文档
2. 联系企业微信技术支持
3. 查看错误码说明：https://open.work.weixin.qq.com/devtool/query 